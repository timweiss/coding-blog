<!DOCTYPE html><html><head><title>Tim's Coding Blog | Deliver user-specific notifications on iOS with AWS SNS</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/blog/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/blog/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/blog/bundle/codedoc-bundle.js"></script><script>window.githubConfig={"repo":"coding-blog","user":"timweiss"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Tim's Coding Blog | Deliver user-specific notifications on iOS with AWS SNS"><meta name="twitter:image" content="https://tims.coding.blog/img/posts/cloud-computing/deliver-user-specific-notifications-on-ios-with-aws-sns/snsxnotifications-light.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Tim's Coding Blog | Deliver user-specific notifications on iOS with AWS SNS"><meta property="og:image" content="https://tims.coding.blog/img/posts/cloud-computing/deliver-user-specific-notifications-on-ios-with-aws-sns/snsxnotifications-light.jpg"></head><body><div class="header-0-0-5"><a class="watermark-0-0-4" href="https://coding.blog" target="_blank"><svg viewBox="0 0 701 443" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="coding.blog" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(-162.000000, -246.000000)" id="Shape"><path d="M538.081948,246.348452 L538.52402,246.445719 L538.52402,246.445719 L538.85529,246.526578 L538.85529,246.526578 L600.956012,263.165455 C602.767076,263.660918 604.526214,264.465865 606.146589,265.591976 C611.80881,269.527048 614.090389,276.211909 612.345003,282.123825 L538.2641,559.728905 C537.816127,561.562539 536.989561,563.335054 535.765607,564.944016 C530.70443,571.597248 520.764856,572.934442 513.564947,567.930724 C507.902727,563.995652 505.621148,557.310791 507.366534,551.398875 L577.145082,289.91439 L546.233523,281.631663 L462.305576,595.917544 L468.439004,634.645619 L493.907962,603.194573 C499.468987,596.327279 509.54413,595.268339 516.411424,600.829364 C523.278717,606.390389 524.337658,616.465532 518.776633,623.332826 L470.948283,682.395919 C466.887248,687.410879 460.418878,689.3283 454.55045,687.832105 L454.212574,687.741996 C448.224449,686.200133 443.421088,681.240355 442.392221,674.744345 L430.503202,599.680031 C430.418831,599.147339 430.361793,598.616628 430.331048,598.089327 C429.783912,595.705405 429.838457,593.220092 430.535776,590.858154 L519.361965,258.223717 L519.447729,257.889555 L519.447729,257.889555 L519.532157,257.586199 L519.627058,257.23399 C520.074771,255.398716 520.901697,253.624577 522.126677,252.014264 C525.828762,247.147643 532.141006,245.125338 538.081948,246.348452 Z M632.156421,656.157784 C640.992977,656.157784 648.156421,663.321228 648.156421,672.157784 C648.156421,680.99434 640.992977,688.157784 632.156421,688.157784 L528.156421,688.157784 C519.319865,688.157784 512.156421,680.99434 512.156421,672.157784 C512.156421,663.321228 519.319865,656.157784 528.156421,656.157784 L632.156421,656.157784 Z M699.234631,342.452157 L857.62655,500.844076 C863.874939,507.092464 863.874939,517.223104 857.62655,523.471493 L699.234631,681.863412 C692.986243,688.1118 682.855603,688.1118 676.607214,681.863412 C670.358826,675.615023 670.358826,665.484383 676.607214,659.235995 L823.686132,512.157077 L676.607214,365.079574 C670.358826,358.831185 670.358826,348.700545 676.607214,342.452157 C682.855603,336.203768 692.986243,336.203768 699.234631,342.452157 Z M347.705627,342.452157 C353.954016,348.700545 353.954016,358.831185 347.705627,365.079574 L200.62671,512.158491 L347.705627,659.235995 C353.954016,665.484383 353.954016,675.615023 347.705627,681.863412 C341.457239,688.1118 331.326599,688.1118 325.07821,681.863412 L166.686292,523.471493 C160.437903,517.223104 160.437903,507.092464 166.686292,500.844076 L325.07821,342.452157 C331.326599,336.203768 341.457239,336.203768 347.705627,342.452157 Z"></path></g></g></svg></a></div><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"cloud-computing/deliver-user-specific-notifications-on-ios-with-aws-sns.md","namespace":"/blog","title":{"base":"Tim's Coding Blog","connector":" | "}}</script><div class="hero-0-0-14" data-mode="light" data-target="desktop" style="margin-bottom: -156px"><img src="https://tims.coding.blog/img/posts/cloud-computing/deliver-user-specific-notifications-on-ios-with-aws-sns/snsxnotifications-light.jpg" class="image-0-0-15" data-hero=""><span class="caption-0-0-16"></span></div><div class="hero-0-0-14" data-mode="light" data-target="mobile" style="margin-bottom: -96px"><img src="https://tims.coding.blog/img/posts/cloud-computing/deliver-user-specific-notifications-on-ios-with-aws-sns/snsxnotifications-light-small.jpg" class="image-0-0-15" data-hero=""><span class="caption-0-0-16"></span></div><div class="hero-0-0-14" data-mode="dark" data-target="desktop" style="margin-bottom: -156px"><img src="https://tims.coding.blog/img/posts/cloud-computing/deliver-user-specific-notifications-on-ios-with-aws-sns/snsxnotifications-dark.jpg" class="image-0-0-15" data-hero=""><span class="caption-0-0-16"></span></div><div class="hero-0-0-14" data-mode="dark" data-target="mobile" style="margin-bottom: -96px"><img src="https://tims.coding.blog/img/posts/cloud-computing/deliver-user-specific-notifications-on-ios-with-aws-sns/snsxnotifications-dark-small.jpg" class="image-0-0-15" data-hero=""><span class="caption-0-0-16"></span></div><h1 class="h-0-0-11 white"><span style=" 
      text-shadow: 0 0 8px black; 
      font-size: 48px"><p>Deliver user-specific notifications on iOS with AWS SNS</p></span></h1><script id="muTbcyWvWx">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("muTbcyWvWx", "DmEvOYtw7XYnMs6x+25YJA==", {"src":"github"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><marker><br>

</marker><h1 id="1-introduction" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>1. Introduction</h1><p><a href="https://aws.amazon.com/de/sns">AWS's SNS</a> is very versatile and generally a good starting point for you when you need to send push notifications to your users. The free tier gives you one million notifications free <strong>per month</strong> and is relatively cheap when scaling up. One thing that has bugged me, though, was the lack of good guidance to quickly get something running. That's why I'm writing this posts, so you don't have to deal with clicking through more than two pages of Google search results.</p><h1 id="2-what-my-project-consists-of" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>2. What my project consists of</h1><p>For this blog post, I'm using a combination of <a href="https://github.com/expressjs/express">express</a>, <a href="https://www.postgresql.org/">Postgres</a> and <a href="https://typeorm.io/">TypeORM</a> for my backend. My <a href="https://github.com/ikkakujuu/suika">starter template</a> for express with TypeScript is still holding up well for small projects and TypeORM is easily integrated as well.</p><p>The iOS app is going to be a simple SwiftUI app, but this guide is mostly architecture-agnostic.</p><h1 id="3-setting-up-sns" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>3. Setting up SNS</h1><p>If you haven't done this already, you need to sign up for an AWS account. Inside the management console, you need to search for SNS.</p><p>There, you'll need to create a new platform application. Look under <strong>mobile</strong> and click create. Now, the tricky stuff happens (well, actually, you'll probably get used to it). </p><h2 id="31-creating-the-push-certificate" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>3.1. Creating the push certificate</h2><p>Inside <a href="https://developer.apple.com/account/resources/certificates/list">Certificates, Identifiers &amp; Profiles</a>, add a new certificate. Select <strong>Apple Push Notification service SSL (Sandbox &amp; Production)</strong>. This way, you don't need to create a new certificate for production. Continue and choose the right App ID. After that, you need to create a <strong>Certificate Signing Request (CSR)</strong>. See <a href="https://help.apple.com/developer-account/#/devbfa00fef7">Apple's guide</a> on how to do it. After that, you should be able to download your new push certificate.</p><p>Install the new certificate and open <strong>Keychain Access</strong>. Go to <strong>Keys</strong> and look for the name you've given your CSR. Expand the private key, select both the private key and the new push certificate, right click with both selected and export them in <em>.p12</em> format.</p><p>Back inside the AWS management console, upload the <em>.p12</em> certificate, apply it and create the platform application.</p><p>Note down the <strong>ARN</strong> of the new endpoint.</p><h2 id="32-creating-an-iam-user" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>3.2. Creating an IAM user</h2><p>To use SNS in your backend, you need to create a new user under IAM as well. It's good to keep users coupled to what they're good for, so we're going to create a user just for our SNS purposes.</p><p>Inside the AWS management console, search for IAM, go to users and click <strong>add user</strong>. Choose a name you like, tick <strong>programmatic access</strong>. For permissions, choose <strong>Attach existing policies directly</strong> and search for SNS. Choose <strong>AmazonSNSFullAccess</strong>. Skip the tags and create the new user.</p><p>Download the credentials as CSV and note down both the <strong>access key ID</strong> as well as the <strong>secret access key</strong>.</p><h1 id="4-backend" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>4. Backend</h1><p>So, now it's time for the backend! I'm assuming you have set up express with some authorization system and TypeORM (or any other database access layer).</p><h2 id="41-routes" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>4.1. Routes</h2><p>For most basic purposes, we only need two routes: one to send the device token to SNS and another one to test our notifications later.</p><p>Inside where you add your routes, create the following routes:</p><pre class="with-bar"><code class="typescript code-0-0-17" tabindex="0"><span class="wmbar-0-0-20"><span></span><span></span><span></span><span>routes.ts</span></span><div class="line-0-0-19 " data-content="router.post('/register', authorize(), async (req, res) => { // --> Your authorize() method should probably add some user object to req"><span class="lineCounter-0-0-18 prim">1</span>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> <span class="token function">authorize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// --&gt; Your authorize() method should probably add some user object to req</span></div><br><div class="line-0-0-19 " data-content="    if (req.body.deviceToken) {"><span class="lineCounter-0-0-18">2</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>deviceToken<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="        try {"><span class="lineCounter-0-0-18">3</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="            const subscription = await notificationService.subscribeNotifications(req.user, req.body.deviceToken); // --> We'll write this later"><span class="lineCounter-0-0-18">4</span>            <span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token keyword">await</span> notificationService<span class="token punctuation">.</span><span class="token function">subscribeNotifications</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>deviceToken<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; We'll write this later</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18 prim">5</span></div><br><div class="line-0-0-19 " data-content="            return res.sendStatus(200);"><span class="lineCounter-0-0-18">6</span>            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="        } catch (error) {"><span class="lineCounter-0-0-18">7</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="            console.error(error);"><span class="lineCounter-0-0-18">8</span>            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">9</span></div><br><div class="line-0-0-19 " data-content="            return res.status(500).send({ code: 'REGISTRATION_ERROR', message: error.message });"><span class="lineCounter-0-0-18 prim">10</span>            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code<span class="token operator">:</span> <span class="token string">'REGISTRATION_ERROR'</span><span class="token punctuation">,</span> message<span class="token operator">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="        }"><span class="lineCounter-0-0-18">11</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="    }"><span class="lineCounter-0-0-18">12</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="});"><span class="lineCounter-0-0-18 prim">13</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>This route will register the device with the supplied <code>deviceToken</code> with SNS. We'll write the <code>notificationService.subscribeNotifications</code> later!</p><pre class="with-bar"><code class="typescript code-0-0-17" tabindex="0"><span class="wmbar-0-0-20"><span></span><span></span><span></span><span>routes.ts</span></span><div class="line-0-0-19 " data-content="router.get('/test/:userId', async (req, res) => {"><span class="lineCounter-0-0-18 prim">1</span>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/test/:userId'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="    await notificationService.notifyUser(parseInt(req.params.userId, 10)); // --> of course, we'll also take a look at this function later"><span class="lineCounter-0-0-18">2</span>    <span class="token keyword">await</span> notificationService<span class="token punctuation">.</span><span class="token function">notifyUser</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; of course, we'll also take a look at this function later</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">3</span></div><br><div class="line-0-0-19 " data-content="    res.send({ message: 'ok' });"><span class="lineCounter-0-0-18">4</span>    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">'ok'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="});"><span class="lineCounter-0-0-18 prim">5</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>For obvious reasons, you should throw out this function once your code runs on production, but it's a good function to test your notification sending code.</p><h2 id="42-notification-service-backend" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>4.2. Notification Service (Backend)</h2><p>It's much less a service and more just a collection of functions to help us with registering for notifications.</p><p>First, we need to set up our connection with AWS. I recommend storing all your secrets and configuration in some config object, which loads them from environment variables. I will give you an example in another blog post sometime.</p><pre class="with-bar"><code class="typescript code-0-0-17" tabindex="0"><span class="wmbar-0-0-20"><span></span><span></span><span></span><span>notificationService.ts</span></span><div class="line-0-0-19 " data-content="const credentials = new AWS.Credentials({ accessKeyId: config.sns.accessKey, secretAccessKey: config.sns.secretAccessKey }); // --> the accessKey and secretAccessKey are the ones you've noted down before when creating the IMS user"><span class="lineCounter-0-0-18 prim">1</span><span class="token keyword">const</span> credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>Credentials</span><span class="token punctuation">(</span><span class="token punctuation">{</span> accessKeyId<span class="token operator">:</span> config<span class="token punctuation">.</span>sns<span class="token punctuation">.</span>accessKey<span class="token punctuation">,</span> secretAccessKey<span class="token operator">:</span> config<span class="token punctuation">.</span>sns<span class="token punctuation">.</span>secretAccessKey <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; the accessKey and secretAccessKey are the ones you've noted down before when creating the IMS user</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">2</span></div><br><div class="line-0-0-19 " data-content="AWS.config.update({credentials, region: config.sns.region }); // --> this is the region you've created your SNS stuff in"><span class="lineCounter-0-0-18">3</span><span class="token constant">AWS</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>credentials<span class="token punctuation">,</span> region<span class="token operator">:</span> config<span class="token punctuation">.</span>sns<span class="token punctuation">.</span>region <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; this is the region you've created your SNS stuff in</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">4</span></div><br><div class="line-0-0-19 " data-content="const sns = new AWS.SNS();"><span class="lineCounter-0-0-18 prim">5</span><span class="token keyword">const</span> sns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>SNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Let's take a look at this function: <code>subscribeNotifications(user: RequestUser, deviceToken: string)</code></p><pre class="with-bar"><code class="typescript code-0-0-17" tabindex="0"><span class="wmbar-0-0-20"><span></span><span></span><span></span><span>notificationService.ts</span></span><div class="line-0-0-19 " data-content="async function subscribeNotifications(user: RequestUser, deviceToken: string) {"><span class="lineCounter-0-0-18 prim">1</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">subscribeNotifications</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token operator">:</span> RequestUser<span class="token punctuation">,</span> deviceToken<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="    const userTopicName = 'user-topic' + user.id; // --> we'll use the topic's name later to identify the user"><span class="lineCounter-0-0-18">2</span>    <span class="token keyword">const</span> userTopicName <span class="token operator">=</span> <span class="token string">'user-topic'</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>id<span class="token punctuation">;</span> <span class="token comment">// --&gt; we'll use the topic's name later to identify the user</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">3</span></div><br><div class="line-0-0-19 " data-content="    const topic = await sns.createTopic({ Name: userTopicName }).promise();"><span class="lineCounter-0-0-18">4</span>    <span class="token keyword">const</span> topic <span class="token operator">=</span> <span class="token keyword">await</span> sns<span class="token punctuation">.</span><span class="token function">createTopic</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Name<span class="token operator">:</span> userTopicName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18 prim">5</span></div><br><div class="line-0-0-19 " data-content="    // first, we created the topic"><span class="lineCounter-0-0-18">6</span>    <span class="token comment">// first, we created the topic</span></div><br><div class="line-0-0-19 " data-content="    if (topic.TopicArn) {"><span class="lineCounter-0-0-18">7</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>topic<span class="token punctuation">.</span>TopicArn<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="        const userEndpointAttributes = 'user-endpoint-' + user.id;"><span class="lineCounter-0-0-18">8</span>        <span class="token keyword">const</span> userEndpointAttributes <span class="token operator">=</span> <span class="token string">'user-endpoint-'</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>id<span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">9</span></div><br><div class="line-0-0-19 " data-content="        // then, we create an endpoint where the device token will subscribe to"><span class="lineCounter-0-0-18 prim">10</span>        <span class="token comment">// then, we create an endpoint where the device token will subscribe to</span></div><br><div class="line-0-0-19 " data-content="        const endpoint = await sns.createPlatformEndpoint({ PlatformApplicationArn: config.sns.arn, Token: deviceToken }).promise(); // --> the endpoint tells SNS &quot;who&quot; to reach, in our case a device specified by the deviceToken"><span class="lineCounter-0-0-18">11</span>        <span class="token keyword">const</span> endpoint <span class="token operator">=</span> <span class="token keyword">await</span> sns<span class="token punctuation">.</span><span class="token function">createPlatformEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">{</span> PlatformApplicationArn<span class="token operator">:</span> config<span class="token punctuation">.</span>sns<span class="token punctuation">.</span>arn<span class="token punctuation">,</span> Token<span class="token operator">:</span> deviceToken <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; the endpoint tells SNS "who" to reach, in our case a device specified by the deviceToken</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">12</span></div><br><div class="line-0-0-19 " data-content="        if (endpoint.EndpointArn) {"><span class="lineCounter-0-0-18">13</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span>EndpointArn<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="            const subscription = await sns.subscribe({ TopicArn: topic.TopicArn, Endpoint: endpoint.EndpointArn, Protocol: 'application' }).promise(); // --> the subscription basically connects our topic with the &quot;client&quot;"><span class="lineCounter-0-0-18">14</span>            <span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token keyword">await</span> sns<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> TopicArn<span class="token operator">:</span> topic<span class="token punctuation">.</span>TopicArn<span class="token punctuation">,</span> Endpoint<span class="token operator">:</span> endpoint<span class="token punctuation">.</span>EndpointArn<span class="token punctuation">,</span> Protocol<span class="token operator">:</span> <span class="token string">'application'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; the subscription basically connects our topic with the "client"</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18 prim">15</span></div><br><div class="line-0-0-19 " data-content="            if (subscription.SubscriptionArn) {"><span class="lineCounter-0-0-18">16</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">.</span>SubscriptionArn<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="                const notificationSubscription = await saveToDatabase(user, userTopicName, topic.TopicArn); // --> we'll take a look at this later"><span class="lineCounter-0-0-18">17</span>                <span class="token keyword">const</span> notificationSubscription <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">saveToDatabase</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> userTopicName<span class="token punctuation">,</span> topic<span class="token punctuation">.</span>TopicArn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; we'll take a look at this later</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">18</span></div><br><div class="line-0-0-19 " data-content="                return notificationSubscription; // --> we don't necessarily need to return this to our client in the end. But if we ever want to give the user the ability to turn off notifications (without turning them off by removing permissions), we could store this somewhere inside the client to make it a bit easier"><span class="lineCounter-0-0-18">19</span>                <span class="token keyword">return</span> notificationSubscription<span class="token punctuation">;</span> <span class="token comment">// --&gt; we don't necessarily need to return this to our client in the end. But if we ever want to give the user the ability to turn off notifications (without turning them off by removing permissions), we could store this somewhere inside the client to make it a bit easier</span></div><br><div class="line-0-0-19 " data-content="            }"><span class="lineCounter-0-0-18 prim">20</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="            throw new Error('Could not create subscription');"><span class="lineCounter-0-0-18">21</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Could not create subscription'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="        } else {"><span class="lineCounter-0-0-18">22</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="            throw new Error('Could not create endpoint');"><span class="lineCounter-0-0-18">23</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Could not create endpoint'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="        }"><span class="lineCounter-0-0-18">24</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="    } else {"><span class="lineCounter-0-0-18 prim">25</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="        throw new Error('Could not create topic');"><span class="lineCounter-0-0-18">26</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Could not create topic'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="    }"><span class="lineCounter-0-0-18">27</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="}"><span class="lineCounter-0-0-18 prim">28</span><span class="token punctuation">}</span></div><br></code></pre><p>Why are we saving the references to the database? It's easier to show you when we take a look at our test function:</p><pre class="with-bar"><code class="typescript code-0-0-17" tabindex="0"><span class="wmbar-0-0-20"><span></span><span></span><span></span><span>notificationService.ts</span></span><div class="line-0-0-19 " data-content="function makeMessage(title: string, message: string) {"><span class="lineCounter-0-0-18 prim">1</span><span class="token keyword">function</span> <span class="token function">makeMessage</span><span class="token punctuation">(</span><span class="token parameter">title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="    const apsContent = JSON.stringify( // --> It's important to stringify the APS payload, as it's invalid syntax otherwise"><span class="lineCounter-0-0-18">2</span>    <span class="token keyword">const</span> apsContent <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span> <span class="token comment">// --&gt; It's important to stringify the APS payload, as it's invalid syntax otherwise</span></div><br><div class="line-0-0-19 " data-content="        {"><span class="lineCounter-0-0-18">3</span>        <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="            aps: {"><span class="lineCounter-0-0-18">4</span>            aps<span class="token operator">:</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="                alert: {&nbsp;"><span class="lineCounter-0-0-18 prim">5</span>                alert<span class="token operator">:</span> <span class="token punctuation">{</span> </div><br><div class="line-0-0-19 " data-content="                    title,"><span class="lineCounter-0-0-18">6</span>                    title<span class="token punctuation">,</span></div><br><div class="line-0-0-19 " data-content="                    body: message"><span class="lineCounter-0-0-18">7</span>                    body<span class="token operator">:</span> message</div><br><div class="line-0-0-19 " data-content="                }"><span class="lineCounter-0-0-18">8</span>                <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="            }"><span class="lineCounter-0-0-18">9</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="        });"><span class="lineCounter-0-0-18 prim">10</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">11</span></div><br><div class="line-0-0-19 " data-content="    return {"><span class="lineCounter-0-0-18">12</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="        'APNS_SANDBOX': apsContent, // --> APNS_SANDBOX is important if you're debugging in non-production environments, because otherwise you wouldn't receive any notifications. Trust me, it wasted an entire hour to figure out why my notifications wouldn't get delivered."><span class="lineCounter-0-0-18">13</span>        <span class="token string">'APNS_SANDBOX'</span><span class="token operator">:</span> apsContent<span class="token punctuation">,</span> <span class="token comment">// --&gt; APNS_SANDBOX is important if you're debugging in non-production environments, because otherwise you wouldn't receive any notifications. Trust me, it wasted an entire hour to figure out why my notifications wouldn't get delivered.</span></div><br><div class="line-0-0-19 " data-content="        'APNS': apsContent,"><span class="lineCounter-0-0-18">14</span>        <span class="token string">'APNS'</span><span class="token operator">:</span> apsContent<span class="token punctuation">,</span></div><br><div class="line-0-0-19 " data-content="        'default': `${title}: ${message}`"><span class="lineCounter-0-0-18 prim">15</span>        <span class="token string">'default'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></div><br><div class="line-0-0-19 " data-content="    };"><span class="lineCounter-0-0-18">16</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="}"><span class="lineCounter-0-0-18">17</span><span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">18</span></div><br><div class="line-0-0-19 " data-content="async function notifyUser(userId: number) {"><span class="lineCounter-0-0-18">19</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">notifyUser</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token operator">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="    const subscription = await getSubscriptionFromDatabase(userId); // --> here, you should fetch our stored SNS topic/references by specifically getting the one for the user"><span class="lineCounter-0-0-18 prim">20</span>    <span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getSubscriptionFromDatabase</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; here, you should fetch our stored SNS topic/references by specifically getting the one for the user</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">21</span></div><br><div class="line-0-0-19 " data-content="    if (subscription) {"><span class="lineCounter-0-0-18">22</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="        const message = makeMessage('hello', 'hello from tims.coding.blog');"><span class="lineCounter-0-0-18">23</span>        <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">makeMessage</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'hello from tims.coding.blog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="        const success = await sns.publish({ Message: JSON.stringify(message), MessageStructure: 'json', TopicArn: subscription.topicArn }).promise(); // --> the topicArn is used to identify our user here"><span class="lineCounter-0-0-18">24</span>        <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> sns<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> MessageStructure<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span> TopicArn<span class="token operator">:</span> subscription<span class="token punctuation">.</span>topicArn <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; the topicArn is used to identify our user here</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18 prim">25</span></div><br><div class="line-0-0-19 " data-content="        if (success.MessageId) {"><span class="lineCounter-0-0-18">26</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">.</span>MessageId<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="            console.log('notified user with message id ' + success.MessageId);"><span class="lineCounter-0-0-18">27</span>            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'notified user with message id '</span> <span class="token operator">+</span> success<span class="token punctuation">.</span>MessageId<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="        } else {"><span class="lineCounter-0-0-18">28</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="            console.log('could not notify user');"><span class="lineCounter-0-0-18">29</span>            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'could not notify user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="        }"><span class="lineCounter-0-0-18 prim">30</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="    }"><span class="lineCounter-0-0-18">31</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">32</span></div><br><div class="line-0-0-19 " data-content="    // you should probably provide some fallback or so here"><span class="lineCounter-0-0-18">33</span>    <span class="token comment">// you should probably provide some fallback or so here</span></div><br><div class="line-0-0-19 " data-content="}"><span class="lineCounter-0-0-18 prim">34</span><span class="token punctuation">}</span></div><br></code></pre><p>You may ask why I'm not just directly publishing to the endpoint. My reasoning for using the topic instead is that in many usecases you don't just want to reach one of the user's devices, but many instead. Then, we might have two endpoints because the user is logged in on both their iPad as well as their iPhone and they are able to receive the same notification on both devices. In that case, you'd need to alter the code where we create the topic, but that should be a minor step once everything else is done.</p><h1 id="5-ios-app" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>5. iOS App</h1><p>For the iOS app, I'm assuming you have set up some sort of authentication services and integrated them inside your request pipeline. If you need some guides on how to build a simple API access layer, I recommend <a href="https://medium.com/swift2go/minimal-swift-api-client-9ea1c9c7946">this blog post</a>.</p><p>Inside the <code>AppDelegate</code>, we'll add a new function called <code>setupNotifications</code>:</p><pre class="with-bar"><code class="swift code-0-0-17" tabindex="0"><span class="wmbar-0-0-20"><span></span><span></span><span></span><span>AppDelegate.swift</span></span><div class="line-0-0-19 " data-content="extension AppDelegate {"><span class="lineCounter-0-0-18 prim">1</span><span class="token keyword">extension</span> <span class="token builtin">AppDelegate</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="    func setupNotifications(application: UIApplication) {"><span class="lineCounter-0-0-18">2</span>    <span class="token keyword">func</span> <span class="token function">setupNotifications</span><span class="token punctuation">(</span>application<span class="token punctuation">:</span> <span class="token builtin">UIApplication</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="        if serviceRegistry.authService.isAuthorized() { // --> or whatever you use to check if the user is signed in"><span class="lineCounter-0-0-18">3</span>        <span class="token keyword">if</span> serviceRegistry<span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">isAuthorized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// --&gt; or whatever you use to check if the user is signed in</span></div><br><div class="line-0-0-19 " data-content="            let center = UNUserNotificationCenter.current()"><span class="lineCounter-0-0-18">4</span>            <span class="token keyword">let</span> center <span class="token operator">=</span> <span class="token builtin">UNUserNotificationCenter</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-19 " data-content="            center.requestAuthorization(options: [.alert, .sound, .badge]) { granted, error in"><span class="lineCounter-0-0-18 prim">5</span>            center<span class="token punctuation">.</span><span class="token function">requestAuthorization</span><span class="token punctuation">(</span>options<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>alert<span class="token punctuation">,</span> <span class="token punctuation">.</span>sound<span class="token punctuation">,</span> <span class="token punctuation">.</span>badge<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> granted<span class="token punctuation">,</span> error <span class="token keyword">in</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">6</span></div><br><div class="line-0-0-19 " data-content="                guard error != nil {"><span class="lineCounter-0-0-18">7</span>                <span class="token keyword">guard</span> error <span class="token operator">!=</span> <span class="token constant">nil</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="                    print(error)"><span class="lineCounter-0-0-18">8</span>                    <span class="token function">print</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span></div><br><div class="line-0-0-19 " data-content="                    return;"><span class="lineCounter-0-0-18">9</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span></div><br><div class="line-0-0-19 " data-content="                }"><span class="lineCounter-0-0-18 prim">10</span>                <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">11</span></div><br><div class="line-0-0-19 " data-content="                print(&quot;successfully requested push&quot;)"><span class="lineCounter-0-0-18">12</span>                <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"successfully requested push"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">13</span></div><br><div class="line-0-0-19 " data-content="                DispatchQueue.main.async { // --> authorization is requested on a background thread, and we need to run registerForRemoteNotifications on the main thread"><span class="lineCounter-0-0-18">14</span>                <span class="token builtin">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span>async <span class="token punctuation">{</span> <span class="token comment">// --&gt; authorization is requested on a background thread, and we need to run registerForRemoteNotifications on the main thread</span></div><br><div class="line-0-0-19 " data-content="                    application.registerForRemoteNotifications()"><span class="lineCounter-0-0-18 prim">15</span>                    application<span class="token punctuation">.</span><span class="token function">registerForRemoteNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-19 " data-content="                }"><span class="lineCounter-0-0-18">16</span>                <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="            }"><span class="lineCounter-0-0-18">17</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="        }"><span class="lineCounter-0-0-18">18</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="    }"><span class="lineCounter-0-0-18">19</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18 prim">20</span></div><br><div class="line-0-0-19 " data-content="    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {"><span class="lineCounter-0-0-18">21</span>    <span class="token keyword">func</span> <span class="token function">application</span><span class="token punctuation">(</span><span class="token number">_</span> application<span class="token punctuation">:</span> <span class="token builtin">UIApplication</span><span class="token punctuation">,</span> didRegisterForRemoteNotificationsWithDeviceToken deviceToken<span class="token punctuation">:</span> <span class="token builtin">Data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="        print(&quot;registered for remote notifications&quot;)"><span class="lineCounter-0-0-18">22</span>        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"registered for remote notifications"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-19 " data-content="        let token = deviceToken.reduce(&quot;&quot;, {$0 + String(format: &quot;%02X&quot;, $1)}) // --> our backend requires a string, so we need to &quot;convert&quot; Data into a string"><span class="lineCounter-0-0-18">23</span>        <span class="token keyword">let</span> token <span class="token operator">=</span> deviceToken<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>$<span class="token number">0</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>format<span class="token punctuation">:</span> <span class="token string">"%02X"</span><span class="token punctuation">,</span> $<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// --&gt; our backend requires a string, so we need to "convert" Data into a string</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">24</span></div><br><div class="line-0-0-19 " data-content="        serviceRegistry.notificationService.subscribeNotifications(deviceToken: token) { (success) in // --> this is where you call our backend API route with the deviceToken"><span class="lineCounter-0-0-18 prim">25</span>        serviceRegistry<span class="token punctuation">.</span>notificationService<span class="token punctuation">.</span><span class="token function">subscribeNotifications</span><span class="token punctuation">(</span>deviceToken<span class="token punctuation">:</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token comment">// --&gt; this is where you call our backend API route with the deviceToken</span></div><br><div class="line-0-0-19 " data-content="            print(success ? &quot;successfully subscribed to notifications&quot; : &quot;could not subscribe to notifications&quot;)"><span class="lineCounter-0-0-18">26</span>            <span class="token function">print</span><span class="token punctuation">(</span>success <span class="token operator">?</span> <span class="token string">"successfully subscribed to notifications"</span> <span class="token punctuation">:</span> <span class="token string">"could not subscribe to notifications"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-19 " data-content="        }"><span class="lineCounter-0-0-18">27</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="    }"><span class="lineCounter-0-0-18">28</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-19 " data-content="}"><span class="lineCounter-0-0-18 prim">29</span><span class="token punctuation">}</span></div><br></code></pre><p>Now, we need to call this function when the app starts up. If you need to register somewhere else (after user onboarding, for example), you could access the application instance <a href="https://stackoverflow.com/a/24114783/7735299">as described here</a>.</p><pre class="with-bar"><code class="swift code-0-0-17" tabindex="0"><span class="wmbar-0-0-20"><span></span><span></span><span></span><span>AppDelegate.swift</span></span><div class="line-0-0-19 " data-content="func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {"><span class="lineCounter-0-0-18 prim">1</span><span class="token keyword">func</span> <span class="token function">application</span><span class="token punctuation">(</span><span class="token number">_</span> application<span class="token punctuation">:</span> <span class="token builtin">UIApplication</span><span class="token punctuation">,</span> didFinishLaunchingWithOptions launchOptions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">UIApplication</span><span class="token punctuation">.</span><span class="token builtin">LaunchOptionsKey</span><span class="token punctuation">:</span> <span class="token builtin">Any</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Bool</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-19 " data-content="    // Override point for customization after application launch."><span class="lineCounter-0-0-18">2</span>    <span class="token comment">// Override point for customization after application launch.</span></div><br><div class="line-0-0-19 " data-content="    self.setupNotifications(application: application)"><span class="lineCounter-0-0-18">3</span>    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">setupNotifications</span><span class="token punctuation">(</span>application<span class="token punctuation">:</span> application<span class="token punctuation">)</span></div><br><div class="line-0-0-19 " data-content=""><span class="lineCounter-0-0-18">4</span></div><br><div class="line-0-0-19 " data-content="    return true"><span class="lineCounter-0-0-18 prim">5</span>    <span class="token keyword">return</span> <span class="token boolean">true</span></div><br><div class="line-0-0-19 " data-content="}"><span class="lineCounter-0-0-18 prim">6</span><span class="token punctuation">}</span></div><br></code></pre><p>That's it! When you call our test route with the right user id, a notification should show up on your device. It should be a real device, though, as push notifications are not supported inside the Simulator.</p><hr><p>Thank you for reading this post! Feel free to reach out to me on <a href="mailto:hey@timweiss.net">hey@timweiss.net</a>! I'd love to hear what you think of this post!</p><div class="contentnav-0-0-10" data-no-search=""><a href="#1-introduction" class="h1" data-content-highlight="1-introduction">1. Introduction</a><a href="#2-what-my-project-consists-of" class="h1" data-content-highlight="2-what-my-project-consists-of">2. What my project consists of</a><a href="#3-setting-up-sns" class="h1" data-content-highlight="3-setting-up-sns">3. Setting up SNS</a><a href="#31-creating-the-push-certificate" class="h2" data-content-highlight="31-creating-the-push-certificate">3.1. Creating the push certificate</a><a href="#32-creating-an-iam-user" class="h2" data-content-highlight="32-creating-an-iam-user">3.2. Creating an IAM user</a><a href="#4-backend" class="h1" data-content-highlight="4-backend">4. Backend</a><a href="#41-routes" class="h2" data-content-highlight="41-routes">4.1. Routes</a><a href="#42-notification-service-backend" class="h2" data-content-highlight="42-notification-service-backend">4.2. Notification Service (Backend)</a><a href="#5-ios-app" class="h1" data-content-highlight="5-ios-app">5. iOS App</a></div></div><div id="-codedoc-toc" class="toc-0-0-7"><div class="content-0-0-8"><p><a href="/blog/">Home</a></p><div class="collapse-0-0-3 "><script id="btgnufNJIU">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("btgnufNJIU", "r+Jv/VS/YauITdU0M0jN1Q==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">Swift Stuff</span><span class="icon-font closed">chevron_right</span></div><div class="content"><p><a href="/blog/swift-stuff/building-a-fully-working-contact-list-in-swiftui">Building a fully working contact list in SwiftUI</a>
<a href="/blog/swift-stuff/making-an-image-navigationbarbutton-actually-usable">Making an Image navigationBarButton actually usable</a></p></div></div><div class="collapse-0-0-3 "><script id="xXinzDLIYw">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("xXinzDLIYw", "r+Jv/VS/YauITdU0M0jN1Q==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">Cloud Computing</span><span class="icon-font closed">chevron_right</span></div><div class="content"><p><a href="/blog/cloud-computing/deliver-user-specific-notifications-on-ios-with-aws-sns">Deliver user-specific notifications on iOS with AWS SNS</a></p></div></div></div></div><div class="footer-0-0-6"><div class="left"><script id="RSGtFjtGvl">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("RSGtFjtGvl", "krgrG9oFN9VQUm9kMirw5Q==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="ykIgxeXsnB">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ykIgxeXsnB", "rt07Ne+r5k791oQZALhn6g==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="ilz_nQbitp">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ilz_nQbitp", "5C7mlfiypfDBeBwm8QT42g==", {"namespace":"/blog"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>